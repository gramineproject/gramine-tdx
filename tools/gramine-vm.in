#!/usr/bin/env bash
# SPDX-License-Identifier: LGPL-3.0-or-later
# Copyright (C) 2023 Intel Corporation

# This file is based on `gramine.in` and modified for VM/TDX environment and QEMU.

BIOS_PATH=@BIOS_PATH@
LIBPAL_PATH=@LIBPAL_PATH@
HOST_PAL_PATH=@HOST_PAL_PATH@
TDSHIM_PAL_PATH=@TDSHIM_PAL_PATH@

APPLICATION=
QEMU_GDB=
ENVS=()
PREFIX=()

if [ "$GDB" == "1" ]; then
    QEMU_GDB="-gdb tcp::9000 -S"
fi

while [ "$1" != "" ];
do
    if [ "$APPLICATION" == "" ]; then
        APPLICATION=$1
        shift
        continue
    fi

    break
done

if [ "$APPLICATION" == "" ]; then
    echo "Usage: $0 [<application>] <args>..."
    exit 2
fi

QEMU_PATH="qemu"
QEMU_VM="-cpu host,host-phys-bits,-kvm-steal-time,pmu=off,+tsc-deadline,+invtsc -m 8G -smp 1"
QEMU_OPTS="-enable-kvm -vga none -nographic -no-reboot -monitor chardev:mux -no-hpet \
    -object memory-backend-file,id=mem,size=8G,mem-path=/dev/shm,share=on \
    -numa node,memdev=mem"

if [ "$TDSHIM_PAL_PATH" == "" ]; then
QEMU_MACHINE="-M q35,kernel_irqchip=split"
QEMU_BINARIES="-kernel $LIBPAL_PATH -device loader,file=$BIOS_PATH"
else
QEMU_MACHINE="-M q35,kernel_irqchip=split,confidential-guest-support=tdx \
    -object tdx-guest,id=tdx,quote-generation-service=vsock:2:4050"
QEMU_BINARIES="-bios $TDSHIM_PAL_PATH"
fi

QEMU_VIRTIO_CONSOLE="-device virtio-serial,iommu_platform=off,romfile= \
                     -chardev stdio,id=mux,mux=on \
                     -device virtconsole,chardev=mux -serial chardev:mux"
QEMU_VIRTIO_FS="-chardev socket,path=/tmp/vhostfs,id=vhostfs \
                -device vhost-user-fs-pci,iommu_platform=off,queue-size=1024,chardev=vhostfs,tag=graminefs"
QEMU_VIRTIO_VSOCK="-device vhost-vsock-pci,iommu_platform=off,guest-cid=10,id=vsockdev"

GRAMINE_ARGS="-gramine init \"$APPLICATION\" $@ -gramine-end"

CMD=("${ENVS[@]}")
CMD+=("${PREFIX[@]}")
CMD+=($QEMU_PATH $QEMU_GDB $QEMU_VM $QEMU_OPTS $QEMU_MACHINE \
        $QEMU_VIRTIO_CONSOLE $QEMU_VIRTIO_FS $QEMU_VIRTIO_VSOCK $QEMU_BINARIES \
        -fw_cfg name=opt/gramine/pwd,string="$PWD" \
        -fw_cfg name=opt/gramine/cmdline,string="$GRAMINE_ARGS" \
        -fw_cfg name=opt/gramine/unixtime_s,string="$EPOCHSECONDS")

virtiofsd --socket-path /tmp/vhostfs --shared-dir / --log-level error --sandbox none &
exec env "${CMD[@]}"
